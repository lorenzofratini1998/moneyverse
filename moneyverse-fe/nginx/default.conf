# Upstream definitions
upstream krakend {
  server moneyverse-krakend:8080;
}

upstream account_sse {
  server moneyverse-account-management:7003;
  keepalive 32;
}

upstream budget_sse {
  server moneyverse-budget-management:7004;
  keepalive 32;
}

upstream transaction_sse {
  server moneyverse-transaction-management:7005;
  keepalive 32;
}

server {
  listen 80;
  server_name localhost;

  root /usr/share/nginx/html;
  index index.html;

  # Security headers
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;

  ##################################################
  # === SSE ENDPOINTS ===
  ##################################################

  location = /accounts/sse {
    proxy_pass http://account_sse/accountsManagement/api/v1/sse;
    include /etc/nginx/sse-proxy.conf;
  }

  location = /budgets/sse {
    proxy_pass http://budget_sse/budgetsManagement/api/v1/sse;
    include /etc/nginx/sse-proxy.conf;
  }

  location = /transactions/sse {
    proxy_pass http://transaction_sse/transactionsManagement/api/v1/sse;
    include /etc/nginx/sse-proxy.conf;
  }

  ##################################################
  # === API PROXIES (to KrakenD API Gateway) ===
  ##################################################

  location ~ ^/(currencies|users|preferences|languages|accounts|budgets|categories|transactions|tags|transfers|subscriptions|analytics)(/|$) {
    proxy_pass http://krakend;
    include /etc/nginx/api-proxy.conf;
  }

  ##################################################
  # === STATIC ASSETS ===
  ##################################################

  # Cache static assets
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000";
    access_log off;
  }

  # Angular client-side routing
  location / {
    try_files $uri $uri/ /index.html;
  }
}
