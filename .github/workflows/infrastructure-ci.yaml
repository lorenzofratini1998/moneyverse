name: Infrastructure CI

on:
  push:
    branches:
      - master
      - feat/frontend
    paths:
      - 'moneyverse-infrastructure/moneyverse-chart/**'
      - '.github/workflows/infrastructure-ci.yaml'
  pull_request:
    paths:
      - 'moneyverse-infrastructure/moneyverse-chart/**'
      - '.github/workflows/infrastructure-ci.yaml'

jobs:
  infrastructure-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4.3.0

      - name: Enable OCI support
        run: |
          helm registry login registry-1.docker.io \
            --username ${{ secrets.DOCKER_USERNAME }} \
            --password ${{ secrets.DOCKER_PASSWORD }}

      - name: Add Bitnami repository
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Build Helm dependencies
        run: |
          cd moneyverse-infrastructure/moneyverse-chart
          
          # Function to build chart dependencies
          build_chart_deps() {
            local chart_path=$1
            if [ -f "$chart_path/Chart.yaml" ]; then
              echo "Building dependencies for $chart_path"
              (cd "$chart_path" && helm dependency build) || {
                echo "Warning: Failed to build dependencies for $chart_path"
                return 1
              }
            fi
          }
          
          # Build helm-library first
          build_chart_deps "apps/helm-library"
          
          # Build all other apps
          for app in apps/*/; do
            if [ "$(basename $app)" != "helm-library" ]; then
              build_chart_deps "$app"
            fi
          done
          
          # Finally build the main chart
          helm dependency build

      - name: Package Helm chart
        run: |
          helm package moneyverse-infrastructure/moneyverse-chart -d moneyverse-infrastructure

      - name: Push Helm chart to Docker Hub
        run: |
          helm push moneyverse-infrastructure/moneyverse-chart-0.1.0.tgz oci://registry-1.docker.io/lfrat